var LyteIDB={isProcessing:!1,restoreData:!1,maintainOrder:!1,idbNamePrefix:"lidb_",idb:{},getBlobURL:function(e){return URL.createObjectURL(new Blob(["importScripts( '"+e+"' );"],{type:"text/javascript"}))},changeIDBState:function(e,t){e.$.inIDB=e.$.inIDB||{},t?(e.$.inIDB[t.model]=e.$.inIDB[t.model]||new Map,e.$.inIDB[t.model].set(t.pK,!0)):Object.defineProperty(e.$.inIDB,"self",{value:!0});var r=store.model[e.$.model._name]&&store.model[e.$.model._name].idb?store.model[e.$.model._name].idb.deserializeKeys:void 0;if(r)for(var o=0;o<r.length;o++){var a=e.$.model.fieldList[r[o]];if(e.hasOwnProperty(r[o])&&"hasMany"==a.relType)if(Array.isArray(e[r[o]])){for(var i=0;i<e[r[o]].length;i++)Lyte.isRecord(e[r[o]][i])&&this.changeIDBState(e[r[o]][i],t?t:{model:e.$.model._name,pK:e.$.pK});e[r[o]].inIDB=e[r[o]].inIDB||Object.defineProperty(e[r[o]],"inIDB",{value:{}}),t?(e[r[o]].inIDB[t.model]=e[r[o]].inIDB[t.model]||new Map,e[r[o]].inIDB[t.model].set(t.pK,!0)):e[r[o]].inIDB.self=!0}else Lyte.isRecord(e[r[o]])&&this.changeIDBState(e[r[o]],t?t:{model:e.$.model._name,pK:e.$.pK})}},initWorker:function(e){return new Promise(function(t,r){var o=LyteIDB.worker=new Worker(LyteIDB.getBlobURL(e));o.onmessage=function(e){var r=e.data;if(r&&r.lyteidb)if("open"==r.type){if("error"!=r.msg){void 0!=store.adapter.application&&store.adapter.application.differIDBAction||setTimeout(function(){LyteIDB.triggerIDBInsertion()},0),Object.defineProperty(LyteIDB,"isIDBOpened",{value:!0}),Object.defineProperty(store.$,"idbOpen",{value:!1});var a=window.location.host,i=localStorage.getItem("idb"+a);void 0==i?localStorage.setItem("idb"+a,1):(i=parseInt(i),localStorage.setItem("idb"+a,i+1)),LyteIDB.restoreData===!1&&window.addEventListener("beforeunload",function(){LyteIDB.removeCurrentIDB()})}}else if("completed4"==r.qProcess){var n=Object.keys(store.$.idbQ2)[0],s=r.data||[];s.forEach(function(e){var t=store.peekRecord(n,e);Lyte.isRecord(t)&&(t.$.inIDB=!0)}),delete store.$.idbQ2[n],LyteIDB.isProcessing=!1}else if(r.hasOwnProperty("code")){var d=r.req,l=LyteIDB[r.model][r.req],c="findRecord"==d?l[r.key].splice(0,1)[0]:l.splice(0,1)[0];200==r.code?c&&c.resolve&&c.resolve(r.data):400==r.code&&c&&c.reject&&c.reject(),0==l.length&&delete LyteIDB[r.model][r.req]}else if(r.pause){var c=LyteIDB[r.model][r.req],m=localStorage.getItem("pause");localStorage.setItem("pause",!m),c&&(c=Array.isArray(c)?c:[c],c.forEach(function(e){e&&e.reject&&e.reject()}))}else if("done"==r.init)return t(o);0==Object.keys(store.$.idbQ2).length&&(LyteIDB.isProcessing=!1)},o.onerror=function(){r()}})},init:function(e){var t=!1,r=window.location.host;localStorage.setItem(r+"parent",Date.now()),window.addEventListener("storage",function(e){e.key==r+"child"&&(t=!0),e.key==r+"parent"&&localStorage.setItem(r+"child",Date.now())});var o=this;return new Promise(function(a,i){var n=e?e.version:void 0,s=LyteIDB.restoreData=e&&e.hasOwnProperty("restoreData")?e.restoreData:LyteIDB.restoreData,d=[],l=LyteIDB.idbNamePrefix+e.name;LyteIDB.initWorker(e?e.url:void 0).then(function(e){for(var c in store.model){var m=store.model[c];if(m.hasOwnProperty("idb")){var I=store.model[c]._pK,y={modelName:c,pK:I};m.idb.hasOwnProperty("maintainOrder")&&(y.maintainOrder=m.idb.maintainOrder),d.push(y)}}var D=store.$.cbScp("application","idbBeforeOpen","adapter");D&&(d=store.$.cB(D,[d])),setTimeout(function(){t?(e.postMessage({tolyteidb:!0,models:d,type:"open",version:n,maintainOrder:LyteIDB.maintainOrder,name:l}),d=[]):s===!1?(localStorage.setItem("idb"+r,1),LyteIDB.removeIDBDatabase().then(function(){e.postMessage({tolyteidb:!0,models:d,type:"open",version:n,maintainOrder:LyteIDB.maintainOrder,name:l}),d=[]})):(e.postMessage({tolyteidb:!0,models:d,type:"open",version:n,maintainOrder:LyteIDB.maintainOrder,name:l}),d=[]),localStorage.removeItem(window.location.host+"child"),localStorage.removeItem(window.location.host+"parent")},20),e.onmessage=function(e){var t=e.data;if(t&&t.lyteidb){if("open"==t.type){if("error"!=t.msg){void 0!=store.adapter.application&&store.adapter.application.differIDBAction||setTimeout(function(){LyteIDB.triggerIDBInsertion()},0),Object.defineProperty(LyteIDB,"isIDBOpened",{value:!0}),Object.defineProperty(store.$,"idbOpen",{value:!1}),LyteIDB.idb[l]=!0;var r=window.location.host,n=localStorage.getItem("idb"+r);return void 0==n?localStorage.setItem("idb"+r,1):(n=parseInt(n),localStorage.setItem("idb"+r,n+1)),LyteIDB.restoreData===!1&&window.addEventListener("beforeunload",function(){LyteIDB.removeCurrentIDB()}),a()}return i()}if("completed4"==t.qProcess){var s=Object.keys(store.$.idbQ2)[0],d=t.data||[];d.forEach(function(e){var t=store.peekRecord(s,e);Lyte.isRecord(t)&&o.changeIDBState(t)}),delete store.$.idbQ2[s],LyteIDB.isProcessing=!1}else if(t.hasOwnProperty("code")){var c=t.req,m=LyteIDB[t.model][t.req],I="findRecord"==c?m[t.key].splice(0,1)[0]:m.splice(0,1)[0];200==t.code?I&&I.resolve&&I.resolve(t.data):400==t.code&&I&&I.reject&&I.reject(),0==m.length&&delete LyteIDB[t.model][t.req]}else if(t.pause){var I=LyteIDB[t.model][t.req],y=localStorage.getItem("pause");localStorage.setItem("pause",!y),I&&(I=Array.isArray(I)?I:[I],I.forEach(function(e){e&&e.reject&&e.reject()}))}}0==Object.keys(store.$.idbQ2).length&&(LyteIDB.isProcessing=!1)}},function(){i()})})},removeCurrentIDB:function(){return new Promise(function(e){var t=window.location.host,r=localStorage.getItem("idb"+t);if(void 0!=r&&parseInt(r)-1!=0)return localStorage.setItem("idb"+t,parseInt(r)-1),e();for(var o in LyteIDB.idb){var a=LyteIDB.removeIDBDatabase(o);console.log(a)}})},deleteIDB:function(e){return new Promise(function(t,r){var o=indexedDB.deleteDatabase(e);o.onsuccess=function(){return t()},o.onerror=function(){return r()}})},removeIDBDatabase:function(){return new Promise(function(e){indexedDB.databases().then(function(t){for(var r,o=t.length,a=0,i=0,n=0;o>n;n++)r=t[n],r.name.startsWith(LyteIDB.idbNamePrefix)&&(i++,LyteIDB.deleteIDB(r.name).then(function(){++a==i&&(localStorage.removeItem("idb"+window.location.host),LyteIDB.didInit=!1,e())},function(){++a==i&&(localStorage.removeItem("idb"+window.location.host),LyteIDB.didInit=!1,e())}));o&&i||e()})})},postMessage:function(e){if(LyteIDB.isIDBOpened){var t={model:e.model,key:e.key,type:e.req,customData:e.customData,queryParams:e.queryParams};delete e.customData;var r,o=store.$.initCB("adapter",t.model,"getIdbName",{args:[t.model]});o&&(r=LyteIDB.idbNamePrefix+o.data);var a,i;if(a=store.$.initCB("serializer",t.model,"beforeIDBGet",{args:[t]}),a&&(i=a.data,i&&"object"==typeof i?(delete i.type,Object.assign(e,i)):e&&e.reject&&e.reject()),e.resolve&&e.reject){LyteIDB[e.model]=LyteIDB[e.model]||{};var n={key:e.key,resolve:e.resolve,reject:e.reject,queryParams:e.queryParams,req:e.req};if("findRecord"==e.req){var s=LyteIDB[e.model][e.req]=LyteIDB[e.model][e.req]||{},d=s[e.key]=s[e.key]||[];d.push(n)}else{var d=LyteIDB[e.model][e.req]=LyteIDB[e.model][e.req]||[];d.push(n)}delete e.resolve,delete e.reject}e.tolyteidb=!0,e.name=r,LyteIDB.worker.postMessage(e)}else e&&e.reject&&e.reject()},IDBInsert:function(){var e=LyteIDB.isProcessing;if(!e&&Object.keys(store.$.idbQ2).length){for(var t=Object.keys(store.$.idbQ2)[0];t&&store.$.idbQ2[t]&&0==store.$.idbQ2[t].length;)delete store.$.idbQ2[t],t=Object.keys(store.$.idbQ2)[0];if(t){var r,o=store.$.idbQ2[t],a=store.modelFor(t)._pK,i=[],n=store.$.initCB("adapter",t,"getIdbName",{args:[t]});n&&(r=LyteIDB.idbNamePrefix+n.data),o.length?(o.forEach(function(e){var t,r;t=store.$.initCB("serializer",e.model,"beforeIDBCrud",{args:[e]}),t?(r=t.data,r&&(delete r.customData,i.push(r))):i.push(e)}),i.length?(LyteIDB.isProcessing={q:o,module:t},console.log(Array.from(o)),LyteIDB.worker.postMessage({tolyteidb:!0,type:"push",module:t,data:o,pK:a,name:r})):delete store.$.idbQ2[t]):delete store.$.idbQ2[t]}}0==Object.keys(store.$.idbQ2).length&&(LyteIDB.isProcessing=!1)},triggerIDBInsertion:function(){setInterval(function(){setTimeout(LyteIDB.IDBInsert,0)},50)}};