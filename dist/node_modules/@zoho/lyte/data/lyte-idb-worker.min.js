function processed(){++qTemp==qLen&&getAll({model:module}).then(function(e){var t=[],r=e.data||[],a=pK.split(",");r.forEach(function(e){var r;a.length>1?(r={},a.forEach(function(t){r[t]=e[t]})):r=e[pK],t.push(r)}),self.postMessage({lyteidb:!0,qProcess:"completed4",data:t})})}function qProcess(e){switch(1==e.queryCache&&"getCachedData"===e.type&&(!e.queryParams||e.queryParams&&0==Object.keys(e.queryParams).length)&&("findAll"==e.req?e.type="getAll":"findRecord"==e.req&&(e.type="get")),e.type){case"getCachedData":getCachedData(e).then(function(t){self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:t,req:e.req,key:e.key})},function(){self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req,key:e.key})});break;case"pushPayload":if(!e.data[e.model]){var t=e.data;e.data={},e.data[e.model]=t}case"findAll":case"findRecord":case"push":push(e,e.type).then(processed,processed);break;case"open":openIDB(e);break;case"create":addMultiple(e).then(processed,processed);break;case"createRecord":addData(e).then(processed,processed);break;case"delete":deleteMultiple(e).then(processed,processed);break;case"destroyRecord":case"deleteRecord":deleteData(e).then(processed,processed);break;case"update":updateMultiple(e).then(processed,processed);break;case"updateRecord":updateData(e).then(processed,processed);break;case"get":e.processKey=!0,getData(e).then(function(t){getCachedMeta(e).then(function(r){if(void 0==t.data)self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req,key:e.key});else{var a={};a[e.model]=t.data,r&&(a.meta=r),self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:a,req:e.req,key:e.key})}},function(){if(void 0==t.data)self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req,key:e.key});else{var r={};r[e.model]=t.data,self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:r,req:e.req,key:e.key})}})},function(){self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req,key:e.key})});break;case"getAll":getAll(e).then(function(t){getCachedMeta(e).then(function(r){if(Array.isArray(t.data)&&!t.data.length)self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req});else{var a={};a[e.model]=t.data,r&&(a.meta=r),self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:a,req:e.req})}},function(){if(Array.isArray(t.data)&&!t.data.length)self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req});else{var r={};r[e.model]=t.data,self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:r,req:e.req})}})},function(){self.postMessage({lyteidb:!0,model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req})});break;case"close":idbObj[currentIdbName].close();break;default:self.postMessage({lyteidb:!0,msg:"No such actions defined "+e.type,data:e.data})}}function getCachedMeta(e){return new Promise(function(t,r){var a=e.model,n=(e.queryParams,e.req),d=e.key;getData({model:"__meta",key:a}).then(function(a){if(void 0==a.data)return r();var o=a.data.cache;o=o[n];var c,s=checkWithQp(o,e,d);if(-1!=s){var i=o[s];if("findRecord"==n){if(!i.key||!d||i.key!=d)return r();c=i.meta}else c=i.data.meta;return t(c)}return r()})})}function getCachedData(e){return new Promise(function(t,r){var a=e.model,n=(e.queryParams,e.req),d=e.key;getData({model:"__meta",key:a}).then(function(o){if(void 0==o.data)return r();var c=o.data.cache;c=c[n];var s=checkWithQp(c,e);if(-1==s)return r();var i,u=c[s];if("findRecord"==n){if(!u.key||!d||u.key!=d)return r();i=[u.data]}else i=u.data[a];if(!i||!i.length){var l={};return"findRecord"==n?(l[e.model]={},void 0!==u.meta&&(l.meta=u.meta)):"findAll"==n&&(l[e.model]=[],u.data&&u.data.meta&&(l.meta=u.data.meta)),t(l)}var m=i.length,f=0,b=[];i.forEach(function(r,d){getData({model:a,key:r,processKey:!0}).then(function(r){if(b[d]=r.data,++f==m){var a={};return"findRecord"==n?(a[e.model]=b[0],void 0!==u.meta&&(a.meta=u.meta)):(a[e.model]=b,u.data&&u.data.meta&&(a.meta=u.data.meta)),t(a)}})})})})}function checkAndRemoveCachedData(e){return new Promise(function(t,r){var a=e.model,n=(e.queryParams,e.key);getData({model:"__meta",key:a}).then(function(e){if(void 0==e.data)return r();var d,o=e.data.cache,c=!1;for(var s in o){d=o[s];for(var i=s,u=d.length,l=u-1;l>=0;l--){var m,f=d[l];if("findRecord"==i){if(!f.key||!n||f.key!=n)return r();d.splice(l,1),c=!0}else if("findAll"==i){m=f.data[a],valsLen=m.length,keyLen=Object.keys(n).length;for(var b=0;valsLen>b;b++){var y=0;for(var p in n)n[p]&&m[b][p]===n[p]&&y++;if(y===keyLen){d.splice(l,1),c=!0;break}}}}}return c?void updateData({model:"__meta",data:e.data,key:a}).then(function(){return t()},function(){return self.console.error("error adding ",msg.data),r()}):t()})})}function postMsg(e){self.postMessage(e)}function getPk(e,t){var r,a=e.split(",");return a.length>1?(r={},a.forEach(function(e){r[e]=t[e]})):1==a.length&&(r={},r[a[0]]=t[a[0]]),r}function push(e,t){return new Promise(function(r,a){var n=e.data,d=(n.length,e.model);checkAndInsert(d,e.data).then(function(){return"pushPayload"==t?r():void getData({model:"__meta",key:d}).then(function(a){var n={};n.queryParams=e.queryParams;var o=n.data=e.data;if("findRecord"==t)n.key=e.key,n.data=getPk(pK,n.data[d]),e.meta&&(n.meta=e.meta);else for(var c=o[d].length,s=0;c>s;s++)o[d][s]=getPk(pK,o[d][s]);if(void 0==a.data){var i={};i.module=d,i.cache={},i.cache[t]=i.data||[],checkQpAndPush(i.cache[t],n,n.key),addData({model:"__meta",data:i}).then(function(){return r()},function(){self.console.error("error adding ",i)})}else a.data.cache[t]=a.data.cache[t]||[],checkQpAndPush(a.data.cache[t],n,n.key),updateData({model:"__meta",data:a.data,key:d}).then(function(){return r()},function(){self.console.error("error adding ",a.data)})},function(){r()})},function(){a()})})}function checkQpAndPush(e,t){t&&!Array.isArray(t)&&(t=[t]),t.forEach(function(t){var r=checkWithQp(e,t);-1==r?e.push(t):e[r]=t})}function checkWithQp(e,t,r){var a=-1;e=e||[];for(var n=e.length,d=t.queryParams||{},o=0;n>o;o++)if(void 0===r||"findRecord"==t.req&&void 0!==r&&e[o].key==r){var c;if(c=e[o].queryParams||{},c==d){a=o;break}var s=Object.keys(c).length,i=Object.keys(d).length;if(s!=i)continue;var u=0;for(var l in c)c[l]==d[l]&&u++;if(u==s){a=o;break}}return a}function checkAndInsert(e,t){var r=!1;return new Promise(function(a,n){t=t[e],t=t||[],Array.isArray(t)||(t=[t]);var d=t.length,o=0;t.length?open(idbObj[currentIdbName].name,idbObj[currentIdbName].version).then(function(){var c,s=idbObj[currentIdbName].transaction([e],"readwrite").objectStore(e);s.indexNames.contains("pk")&&(s=s.index("pk")),t.forEach(function(i){if("string"==typeof s.keyPath)c=i[s.keyPath];else if(Array.isArray(s.keyPath)){var u=[];s.keyPath.forEach(function(e){u.push(i[e])}),c=u}getData({model:e,key:c}).then(function(c){var s=c.data;void 0==s?addData({model:e,data:i}).then(function(){return o++,o==d?r?n():a(t):void 0},function(){return r=!0,o++,o==d?r?n():a(t):void 0}):updateData({model:e,data:i}).then(function(){return o++,o==d?r?n():a(t):void 0},function(){return r=!0,o++,o==d?r?n():a(t):void 0})})})}):a()})}function openIDB(e){var t=e.name||"lyte",r=e.version,a=e.models,n=e.maintainOrder;open(t,r,a,n).then(function(){idbObj[currentIdbName].close(),self.postMessage({lyteidb:!0,msg:"successfully upgraded db",type:"open"})},function(){self.postMessage({lyteidb:!0,msg:"error"})})}function open(e,t,r,a){return new Promise(function(n,d){var o=indexedDB.open(e,t);o.onupgradeneeded=function(e){idbObj[currentIdbName]=e.target.result,r&&r.forEach(function(e){if(!idbObj[currentIdbName].objectStoreNames.contains(e.modelName)){var t=e.hasOwnProperty("maintainOrder")?e.maintainOrder:a;if(t===!0){var r=idbObj[currentIdbName].createObjectStore(e.modelName,{autoIncrement:!0});r.createIndex("pk",e.pK.split(","))}else var r=idbObj[currentIdbName].createObjectStore(e.modelName,{keyPath:e.pK.split(",")})}}),idbObj[currentIdbName].objectStoreNames.contains("__meta")||idbObj[currentIdbName].createObjectStore("__meta",{keyPath:"module"}),n({lyteidb:!0,msg:"successfully upgraded db",type:"open"})},o.onblocked=function(){d({lyteidb:!0,msg:"error"})},o.onsuccess=function(e){idbObj[currentIdbName]=e.target.result,idbObj[currentIdbName].addEventListener("versionchange",function(){console.log("version change",arguments)}),n({lyteidb:!0,msg:"successfully opened db",type:"open"})},o.onerror=function(){d({lyteidb:!0,msg:"error"})}})}function addMultiple(e){return new Promise(function(t){var r=e.data.length,a=0;e.data.forEach(function(n){addData({model:e.model,data:n},!1).then(function(){return++a==r?(idbObj[currentIdbName].close(),t()):void 0},function(){return++a==r?(idbObj[currentIdbName].close(),t()):void 0})})})}function addData(e,t){return new Promise(function(r,a){var n=e.data,d=e.model;open(idbObj[currentIdbName].name,idbObj[currentIdbName].version).then(function(){var e=idbObj[currentIdbName].transaction([d],"readwrite").objectStore(d),o=e.add(n);o.onsuccess=function(){return t!==!1?idbObj[currentIdbName].close():void 0,r({msg:"Successfully added data"})},o.onerror=function(){return t!==!1?idbObj[currentIdbName].close():void 0,a({msg:"Error while adding data"})},o.oncomplete=function(){return t!==!1?idbObj[currentIdbName].close():void 0,r({msg:"Successfully added data"})}},function(){return a({msg:"Cannot open indexeddb"})})})}function deleteMultiple(e){return new Promise(function(t){var r=e.data.length,a=0;e.data.forEach(function(n){deleteData({model:e.model,key:n},!1).then(function(){return++a==r?(idbObj[currentIdbName].close(),t()):void 0},function(){return++a==r?(idbObj[currentIdbName].close(),t()):void 0})})})}function deleteData(e,t){return new Promise(function(r,a){var n=e.model,d=e.key;open(idbObj[currentIdbName].name,idbObj[currentIdbName].version).then(function(){var o,c=idbObj[currentIdbName].transaction([n],"readwrite").objectStore(n);if(c.indexNames.contains("pk")){if(o=c.index("pk"),"string"==typeof o.keyPath)e.key=d=e.key[o.keyPath];else if(Array.isArray(o.keyPath)){var s=[];o.keyPath.forEach(function(t){s.push(e.key[t])}),d=s}openCursorForKey(o,d).then(function(n){var d=n.cursor.primaryKey,o=c.delete(d);o.onsuccess=function(){return t!==!1?idbObj[currentIdbName].close():void 0,1!=e.queryCache?r({msg:"Successfully deleted data"}):void checkAndRemoveCachedData(e).then(function(){return r({msg:"Successfully deleted data"})},function(){return r({msg:"Successfully deleted data"})})},o.onerror=function(){return t!==!1?idbObj[currentIdbName].close():void 0,a({msg:"Error while deleting data"})},o.oncomplete=function(){return t!==!1?idbObj[currentIdbName].close():void 0,r({msg:"Successfully deleted data"})}})}else{if("string"==typeof c.keyPath)e.key=d=e.key[c.keyPath];else if(Array.isArray(c.keyPath)){var s=[];c.keyPath.forEach(function(t){s.push(e.key[t])}),d=s}var i=c.delete(d);i.onsuccess=function(){return t!==!1?idbObj[currentIdbName].close():void 0,1!=e.queryCache?r({msg:"Successfully deleted data"}):void checkAndRemoveCachedData(e).then(function(){return r({msg:"Successfully deleted data"})},function(){return r({msg:"Successfully deleted data"})})},i.onerror=function(){return t!==!1?idbObj[currentIdbName].close():void 0,a({msg:"Error while deleting data"})},i.oncomplete=function(){return t!==!1?idbObj[currentIdbName].close():void 0,r({msg:"Successfully deleted data"})}}},function(){return a({msg:"Cannot open indexeddb"})})})}function updateMultiple(e){return new Promise(function(t){var r=e.data.length,a=0;e.data.forEach(function(){updateData({model:e.model,data:e.data},!1).then(function(){return++a==r?(idbObj[currentIdbName].close(),t()):void 0},function(){return++a==r?(idbObj[currentIdbName].close(),t()):void 0})})})}function updateData(e,t){return new Promise(function(r,a){{var n=e.model,d=e.data;e.key}getData(e).then(function(o){var c=o.data;if(void 0==o.data)addData(e).then(function(){return r({msg:"Successfully added data"})},function(){return a({msg:"Error while adding data"})});else{for(var s in d)c[s]=d[s];open(idbObj[currentIdbName].name,idbObj[currentIdbName].version).then(function(){var d,o,i=idbObj[currentIdbName].transaction([n],"readwrite").objectStore(n);if(i.indexNames.contains("pk")){if(o=i.index("pk"),d=!0,"string"==typeof o.keyPath)e.key=s=e.data[o.keyPath];else if(Array.isArray(o.keyPath)){var u=[];o.keyPath.forEach(function(t){u.push(e.data[t])}),s=u}openCursorForKey(o,s).then(function(n){var d=n.cursor.primaryKey;void 0!==d&&openCursorForKey(i,d).then(function(n){var d=n.cursor.update(e.data);d.onsuccess=function(e){e.target.result;return t!==!1?idbObj[currentIdbName].close():void 0,r({msg:"Successfully updated data"})},d.onerror=function(){return t!==!1?idbObj[currentIdbName].close():void 0,a({msg:"Error while updating data"})},d.oncomplete=function(){return t!==!1?idbObj[currentIdbName].close():void 0,r({msg:"Successfully updated data"})}})})}else{var l=i.put(c);l.onsuccess=function(){return t!==!1?idbObj[currentIdbName].close():void 0,r({msg:"Successfully updated data"})},l.onerror=function(){return t!==!1?idbObj[currentIdbName].close():void 0,a({msg:"Error while updating data"})},l.oncomplete=function(){return t!==!1?idbObj[currentIdbName].close():void 0,r({msg:"Successfully updated data"})}}},function(){return a({msg:"Cannot open indexeddb"})})}},function(){return a({msg:"Error while updating data"})})})}function getData(e){return new Promise(function(t,r){var a=e.model,n=e.key;return idbObj[currentIdbName]&&idbObj[currentIdbName].objectStoreNames.contains(a)?void open(idbObj[currentIdbName].name,idbObj[currentIdbName].version).then(function(){var d=idbObj[currentIdbName].transaction([a],"readwrite").objectStore(a);if(d.indexNames.contains("pk")&&(d=d.index("pk")),e.processKey){if(Array.isArray(d.keyPath)){var o=[];n&&"object"==typeof n?d.keyPath.forEach(function(e){o.push(n[e])}):o.push(n),n=o}}else if(!n&&e.data)if("string"==typeof d.keyPath)n=e.data[d.keyPath];else if(Array.isArray(d.keyPath)){var o=[];d.keyPath.forEach(function(t){o.push(e.data[t])}),n=o}var c=d.get(n);c.onsuccess=function(e){return idbObj[currentIdbName].close(),t({msg:"Successfully got data success",data:e.target.result})},c.onerror=function(){return idbObj[currentIdbName].close(),r({msg:"Error while getting data"})},c.oncomplete=function(e){return idbObj[currentIdbName].close(),t({msg:"Successfully got data complete",data:e.target.result})}},function(){return r({msg:"Cannot open indexeddb"})}):r({msg:"Error while getting data"})})}function getAll(e){return new Promise(function(t,r){var a=e.model;return idbObj[currentIdbName]&&idbObj[currentIdbName].objectStoreNames.contains(a)?void open(idbObj[currentIdbName].name,idbObj[currentIdbName].version).then(function(){var e=idbObj[currentIdbName].transaction([a],"readwrite").objectStore(a),n=e.getAll();n.onsuccess=function(e){return idbObj[currentIdbName].close(),t({msg:"Successfully got data",data:e.target.result})},n.onerror=function(){return idbObj[currentIdbName].close(),r({msg:"Error while getting data"})},n.oncomplete=function(e){return idbObj[currentIdbName].close(),t({msg:"Successfully got data",data:e.target.result})}},function(){return r({msg:"Cannot open indexeddb"})}):r({msg:"Error while getting data"})})}function openCursorForKey(e,t){return new Promise(function(r,a){var n=e.openCursor(t);n.onsuccess=function(e){return r({cursor:e.target.result})},n.onerror=function(){return a("Curson not established")}})}var idbObj={},qLen,qTemp,pK,module,currentIdbName;self.onmessage=function(e){var t=e.data;if(t.tolyteidb)if(currentIdbName=t.name||"lyte","open"==t.type||idbObj.hasOwnProperty(currentIdbName))if("push"==t.type){qLen=qTemp=0,module=t.module,pK=void 0;var r=t.data;Array.isArray(r)||(r=[r]),pK=t.pK,qLen=r.length,r.forEach(function(e){qProcess(e,e.type)})}else qProcess(t,t.type);else self.postMessage({lyteidb:!0,pause:!0,model:t.model,type:t.type})},self.postMessage({lyteidb:!0,init:"done"});